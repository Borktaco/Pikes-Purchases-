<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pike Purchases</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1rem;
      background: #0b1b2b;
      color: #f5f7fb;
    }
    h1 {
      text-align: center;
      color: #e6f1ff;
    }
    .card {
      background: #142237;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 8px 16px rgba(0,0,0,0.35);
    }
    label {
      display: block;
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: #c2d4f2;
    }
    input, select {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.25rem;
      border-radius: 8px;
      border: 1px solid #31415f;
      background: #0f1a2a;
      color: #f5f7fb;
      box-sizing: border-box;
    }
    button {
      margin-top: 0.75rem;
      padding: 0.6rem 1rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      background: #00c46a;
      color: #04101f;
      box-shadow: 0 6px 12px rgba(0,0,0,0.4);
    }
    button.secondary {
      background: #1f2f4a;
      color: #e6f1ff;
      margin-left: 0.5rem;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .col {
      flex: 1 1 240px;
    }
    .balance {
      font-size: 1.6rem;
      font-weight: 700;
    }
    .tag {
      display: inline-block;
      padding: 0.15rem 0.6rem;
      border-radius: 999px;
      font-size: 0.7rem;
      margin-left: 0.25rem;
      background: #243556;
      color: #a9c3ff;
      vertical-align: middle;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.75rem;
      font-size: 0.85rem;
    }
    th, td {
      padding: 0.4rem 0.5rem;
      border-bottom: 1px solid #1f2f3d;
      text-align: left;
    }
    th {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #8fa2c7;
    }
    tr.income td {
      color: #6fffb0;
    }
    tr.expense td {
      color: #ff9f9f;
    }
    .pill {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #223351;
      color: #c2d4f2;
    }
    .chart-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 0.75rem;
    }
    .chart-box {
      flex: 1 1 260px;
      min-height: 160px;
      background: #0f1a2a;
      border-radius: 10px;
      padding: 0.5rem;
      border: 1px solid #223351;
      font-size: 0.8rem;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      background: #132544;
      margin: 0.15rem;
      font-size: 0.7rem;
    }
    .chip span {
      margin-left: 0.25rem;
      color: #9fb4dd;
    }
    .status-bar {
      font-size: 0.8rem;
      color: #9fb4dd;
      margin-top: 0.5rem;
    }
    .status-badge {
      display: inline-block;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      background: #1a2b48;
      font-size: 0.7rem;
      margin-right: 0.25rem;
    }
    .error {
      color: #ff9f9f;
      margin-top: 0.3rem;
      font-size: 0.8rem;
    }
    @media (max-width: 600px) {
      body {
        padding: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <h1>Pike Purchases</h1>

  <div class="card">
    <div class="row">
      <div class="col">
        <div>Current Balance Owed</div>
        <div class="balance" id="currentBalance">$0.00</div>
        <div class="status-bar" id="summaryStats"></div>
      </div>
      <div class="col">
        <label>
          Quick filters
        </label>
        <div>
          <button class="secondary" type="button" id="filterAll">All</button>
          <button class="secondary" type="button" id="filterSubscriptions">Subscriptions</button>
          <button class="secondary" type="button" id="filterMovies">Movies</button>
          <button class="secondary" type="button" id="filterGames">Games</button>
        </div>
        <div class="status-bar">
          <span class="status-badge" id="filterLabel">Showing: All</span>
          <span id="rowCountLabel"></span>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2 style="margin-top:0;">Add purchase or payment</h2>
    <div class="row">
      <div class="col">
        <label for="desc">Description</label>
        <input id="desc" type="text" placeholder="Movie, game, subscription..." />

        <label for="amount">Amount</label>
        <input id="amount" type="number" step="0.01" placeholder="12.99" />
      </div>
      <div class="col">
        <label for="category">Category</label>
        <select id="category">
          <option value="subscription">Subscription</option>
          <option value="movie">Movie</option>
          <option value="game">Game</option>
          <option value="other">Other</option>
        </select>

        <label for="type">Type</label>
        <select id="type">
          <option value="expense">Charge (money going out)</option>
          <option value="income">Payment (money coming in)</option>
        </select>
      </div>
    </div>
    <button id="addBtn" type="button">Save to Pike sheet</button>
    <span id="saveSpinner" style="margin-left:0.5rem; font-size:0.8rem; display:none;">Saving…</span>
    <div id="formError" class="error"></div>
  </div>

  <div class="card">
    <h2 style="margin-top:0;">History</h2>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Description</th>
          <th>Amount</th>
          <th>Category</th>
          <th>Type</th>
        </tr>
      </thead>
      <tbody id="historyBody"></tbody>
    </table>
  </div>

  <div class="card">
    <h2 style="margin-top:0;">Snapshots</h2>
    <div class="chart-row">
      <div class="chart-box" id="categorySummaryBox">
        <strong>By category (lifetime)</strong>
        <div id="categoryChips"></div>
      </div>
      <div class="chart-box" id="typeSummaryBox">
        <strong>Charges vs payments</strong>
        <div id="typeChips"></div>
      </div>
    </div>
  </div>

  <script>
    // Your real live API URL for Pike:
    const API_URL = "https://script.google.com/macros/s/AKfycbzgR8n39Zbf-hZmC-4qVnupel-VVO2-ExljH4RZaeDukLaj9XhGi7ub0Y7EQP4psSaV/exec";

    const historyBody = document.getElementById('historyBody');
    const currentBalanceEl = document.getElementById('currentBalance');
    const summaryStatsEl = document.getElementById('summaryStats');
    const categoryChipsEl = document.getElementById('categoryChips');
    const typeChipsEl = document.getElementById('typeChips');
    const filterLabel = document.getElementById('filterLabel');
    const rowCountLabel = document.getElementById('rowCountLabel');
    const formError = document.getElementById('formError');
    const addBtn = document.getElementById('addBtn');
    const saveSpinner = document.getElementById('saveSpinner');

    const filterAllBtn = document.getElementById('filterAll');
    const filterSubscriptionsBtn = document.getElementById('filterSubscriptions');
    const filterMoviesBtn = document.getElementById('filterMovies');
    const filterGamesBtn = document.getElementById('filterGames');

    let allRows = [];
    let activeFilter = 'all';

    function formatMoney(value) {
      const n = Number(value) || 0;
      const sign = n < 0 ? '-' : '';
      return sign + '$' + Math.abs(n).toFixed(2);
    }

    // Interpret sheet data so:
    // - Charges add to what Pike owes (positive)
    // - Payments subtract from what Pike owes (negative)
    function normalizedAmount(row) {
      const amt = Number(row.amount) || 0;
      if (row.type === 'expense') {
        return amt;      // charge increases owed
      } else if (row.type === 'income') {
        return -amt;     // payment reduces owed
      }
      return amt;
    }

    function computeStats(rows) {
      let balance = 0;
      let totalCharges = 0;
      let totalPayments = 0;
      const byCategory = {};
      const byType = { expense: 0, income: 0 };

      for (const row of rows) {
        const norm = normalizedAmount(row);

        // balance is sum of normalized amounts
        balance += norm;

        if (row.type === 'expense') {
          totalCharges += Math.abs(norm);
        } else if (row.type === 'income') {
          totalPayments += Math.abs(norm);
        }

        const cat = row.category || 'other';
        if (!byCategory[cat]) byCategory[cat] = 0;
        byCategory[cat] += Math.abs(norm);

        if (!byType[row.type]) byType[row.type] = 0;
        byType[row.type] += Math.abs(norm);
      }

      return { balance, totalCharges, totalPayments, byCategory, byType };
    }

    function renderTable(rows) {
      historyBody.innerHTML = '';
      for (const row of rows) {
        const tr = document.createElement('tr');
        tr.className = row.type === 'income' ? 'income' : 'expense';

        const dateTd = document.createElement('td');
        dateTd.textContent = row.date || '';
        tr.appendChild(dateTd);

        const descTd = document.createElement('td');
        descTd.textContent = row.desc || '';
        tr.appendChild(descTd);

        const amtTd = document.createElement('td');
        // Show the original entered amount (positive)
        amtTd.textContent = '$' + (Number(row.amount) || 0).toFixed(2);
        tr.appendChild(amtTd);

        const catTd = document.createElement('td');
        const cat = row.category || 'other';
        const catSpan = document.createElement('span');
        catSpan.className = 'pill';
        catSpan.textContent = cat;
        catTd.appendChild(catSpan);
        tr.appendChild(catTd);

        const typeTd = document.createElement('td');
        const typeSpan = document.createElement('span');
        typeSpan.className = 'pill';
        typeSpan.textContent = row.type === 'income' ? 'Payment' : 'Charge';
        typeTd.appendChild(typeSpan);
        tr.appendChild(typeTd);

        historyBody.appendChild(tr);
      }
    }

    function renderSummary(rows) {
      const stats = computeStats(rows);

      // Clamp negative balance to 0 (no “-1 owed” weirdness)
      const displayBalance = stats.balance < 0 ? 0 : stats.balance;
      currentBalanceEl.textContent = formatMoney(displayBalance);

      summaryStatsEl.textContent =
        'Total charges: ' + formatMoney(stats.totalCharges) +
        ' · Total payments: ' + formatMoney(stats.totalPayments);

      categoryChipsEl.innerHTML = '';
      const cats = Object.keys(stats.byCategory);
      if (cats.length === 0) {
        categoryChipsEl.textContent = 'No data yet.';
      } else {
        for (const cat of cats) {
          const chip = document.createElement('span');
          chip.className = 'chip';
          chip.textContent = cat;
          const valSpan = document.createElement('span');
          valSpan.textContent = formatMoney(stats.byCategory[cat]);
          chip.appendChild(valSpan);
          categoryChipsEl.appendChild(chip);
        }
      }

      typeChipsEl.innerHTML = '';
      const typeMap = { expense: 'Charges', income: 'Payments' };
      for (const key of Object.keys(stats.byType)) {
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.textContent = typeMap[key] || key;
        const valSpan = document.createElement('span');
        valSpan.textContent = formatMoney(stats.byType[key]);
        chip.appendChild(valSpan);
        typeChipsEl.appendChild(chip);
      }

      rowCountLabel.textContent = rows.length + ' row' + (rows.length === 1 ? '' : 's');
    }

    function applyFilter() {
      let filtered = allRows;
      if (activeFilter === 'subscriptions') {
        filtered = allRows.filter(r => r.category === 'subscription');
        filterLabel.textContent = 'Showing: Subscriptions';
      } else if (activeFilter === 'movies') {
        filtered = allRows.filter(r => r.category === 'movie');
        filterLabel.textContent = 'Showing: Movies';
      } else if (activeFilter === 'games') {
        filtered = allRows.filter(r => r.category === 'game');
        filterLabel.textContent = 'Showing: Games';
      } else {
        filterLabel.textContent = 'Showing: All';
      }
      renderTable(filtered);
      renderSummary(filtered);
    }

    filterAllBtn.addEventListener('click', () => {
      activeFilter = 'all';
      applyFilter();
    });
    filterSubscriptionsBtn.addEventListener('click', () => {
      activeFilter = 'subscriptions';
      applyFilter();
    });
    filterMoviesBtn.addEventListener('click', () => {
      activeFilter = 'movies';
      applyFilter();
    });
    filterGamesBtn.addEventListener('click', () => {
      activeFilter = 'games';
      applyFilter();
    });

    async function loadHistory() {
      formError.textContent = '';
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        if (!data.success) {
          throw new Error(data.error || 'Unknown error from server');
        }
        allRows = data.rows || [];
        applyFilter();
      } catch (err) {
        formError.textContent = 'Error loading history: ' + err.message;
      }
    }

    async function addRow() {
      formError.textContent = '';
      const desc = document.getElementById('desc').value.trim();
      const amountStr = document.getElementById('amount').value;
      const category = document.getElementById('category').value;
      const type = document.getElementById('type').value;

      if (!desc) {
        formError.textContent = 'Please enter a description.';
        return;
      }
      const amount = Number(amountStr);
      if (!amount || amount <= 0) {
        formError.textContent = 'Please enter a positive amount.';
        return;
      }

      addBtn.disabled = true;
      saveSpinner.style.display = 'inline';

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'add',
            desc,
            amount,
            category,
            type
          })
        });
        const data = await res.json();
        if (!data.success) {
          throw new Error(data.error || 'Unknown error from server');
        }

        document.getElementById('amount').value = '';
        document.getElementById('desc').value = '';

        allRows = data.rows || [];
        applyFilter();
      } catch (err) {
        formError.textContent = 'Error saving: ' + err.message;
      } finally {
        addBtn.disabled = false;
        saveSpinner.style.display = 'none';
      }
    }

    addBtn.addEventListener('click', addRow);

    loadHistory();
  </script>
</body>
</html>
