<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Pikes Purchases</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
            background-color:#020b08;
            min-height:100vh;
            padding:20px 15px 120px;
            overflow-x:hidden;
            color:#e5f5ea;
        }

        .container { max-width:900px; margin:0 auto; }

        .header {
            background:linear-gradient(135deg,#066b3a,#0b8749);
            border-radius:20px;
            padding:20px;
            text-align:center;
            box-shadow:0 8px 24px rgba(0,0,0,0.6);
            margin-bottom:14px;
            border:1px solid rgba(255,255,255,0.08);
        }

        .header h1 {
            color:#fdfefc;
            font-size:26px;
            font-weight:700;
            margin-bottom:4px;
        }

        .header .subtitle {
            color:rgba(240,255,244,0.9);
            font-size:13px;
            font-weight:500;
        }

        .badge-row { margin-bottom:16px; }

        .badge {
            background:rgba(7,36,24,0.95);
            border-radius:18px;
            padding:12px 16px;
            box-shadow:0 3px 14px rgba(0,0,0,0.6);
            border:1px solid rgba(255,255,255,0.08);
        }

        .badge-label {
            font-size:11px;
            color:#9fb8aa;
            font-weight:600;
            text-transform:uppercase;
            letter-spacing:0.5px;
            margin-bottom:4px;
        }

        .badge-value {
            font-size:22px;
            font-weight:700;
            color:#f5fff8;
        }

        .card {
            background:rgba(5,24,16,0.96);
            border-radius:18px;
            padding:18px;
            margin-bottom:14px;
            box-shadow:0 4px 18px rgba(0,0,0,0.7);
            border:1px solid rgba(255,255,255,0.06);
        }

        .card-header {
            font-size:15px;
            font-weight:700;
            color:#c4f5d7;
            margin-bottom:10px;
            text-transform:uppercase;
            letter-spacing:0.5px;
        }

        .form-grid {
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
            gap:10px;
            margin-bottom:10px;
        }

        .input-group label {
            display:block;
            font-size:12px;
            color:#a7c4b5;
            margin-bottom:4px;
            font-weight:600;
        }

        .input-group input,
        .input-group select {
            width:100%;
            padding:10px 12px;
            border:1px solid #355243;
            border-radius:10px;
            font-size:14px;
            background:#071712;
            color:#e8fff2;
            transition:all 0.25s;
        }

        .input-group input::placeholder { color:#5d7568; }

        .input-group input:focus,
        .input-group select:focus {
            outline:none;
            border-color:#4caf6f;
            background:#0c2216;
        }

        .button-row {
            display:flex;
            flex-wrap:wrap;
            gap:10px;
            margin-top:4px;
        }

        .btn {
            flex:0 0 auto;
            padding:11px 16px;
            border:none;
            border-radius:12px;
            font-size:14px;
            font-weight:700;
            cursor:pointer;
            transition:all 0.2s;
            box-shadow:0 3px 14px rgba(0,0,0,0.6);
            text-transform:uppercase;
            letter-spacing:0.5px;
        }

        .btn-add {
            background:linear-gradient(135deg,#2eaf5d,#4dd27a);
            color:#021007;
        }

        .btn-paid {
            background:linear-gradient(135deg,#d23a3a,#ff784e);
            color:#1b0505;
        }

        .btn:active { transform:scale(0.96); }

        .chart-shell { display:flex; flex-direction:column; gap:6px; }

        .chart-meta { font-size:12px; color:#a2b8ab; }

        .chart-canvas-wrap {
            background:#040e0a;
            border-radius:12px;
            padding:10px;
            border:1px dashed rgba(255,255,255,0.1);
        }

        canvas { width:100%; max-height:220px; }

        .history-header-row {
            display:flex;
            flex-wrap:wrap;
            gap:10px;
            align-items:flex-end;
            margin-bottom:8px;
        }

        .history-list {
            max-height:320px;
            overflow-y:auto;
            padding-right:4px;
        }

        .history-item {
            display:grid;
            grid-template-columns:80px 1fr 90px;
            gap:8px;
            padding:8px 0;
            border-bottom:1px solid #1a2a20;
            font-size:13px;
            align-items:center;
        }

        .history-item:last-child { border-bottom:none; }

        .h-date {
            color:#7f9387;
            font-weight:600;
        }

        .h-main { color:#e5f5ea; }

        .h-desc { font-weight:600; }

        .h-note {
            font-size:11px;
            color:#7e9688;
        }

        .h-amt {
            text-align:right;
            font-weight:700;
        }

        .h-amt.negative { color:#ff8a8a; }
        .h-amt.positive { color:#8dffb0; }

        .h-bal {
            font-size:11px;
            color:#7e9688;
            text-align:right;
        }

        .notification {
            position:fixed;
            bottom:20px;
            left:50%;
            transform:translateX(-50%);
            background:#06140d;
            padding:10px 18px;
            border-radius:999px;
            box-shadow:0 4px 18px rgba(0,0,0,0.8);
            font-size:13px;
            font-weight:600;
            display:none;
            z-index:1000;
            color:#e9fff5;
            border:1px solid #2f4b3a;
        }

        .notification.show { display:block; }

        @media (max-width:600px) {
            .history-item {
                grid-template-columns:70px 1fr;
                grid-template-rows:auto auto;
            }
            .h-amt,
            .h-bal { text-align:left; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>The Pikes Purchases</h1>
        <div class="subtitle">Account of what Pike owes for movies, subscriptions, games, and extras.</div>
    </div>

    <div class="badge-row">
        <div class="badge">
            <div class="badge-label">Current Balance Owed</div>
            <div class="badge-value" id="balanceOwed">$0.00</div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Add New Purchase</div>
        <div class="form-grid">
            <div class="input-group">
                <label>Date</label>
                <input type="date" id="dateInput">
            </div>
            <div class="input-group">
                <label>Description</label>
                <input type="text" id="descInput" placeholder="Movie, subscription, game…">
            </div>
            <div class="input-group">
                <label>Cost (USD)</label>
                <input type="number" id="amountInput" step="0.01" inputmode="decimal" placeholder="0.00">
            </div>
            <div class="input-group">
                <label>Category</label>
                <select id="categoryInput">
                    <option value="Movies">Movies</option>
                    <option value="Subscriptions">Subscriptions</option>
                    <option value="Games/Robux">Games/Robux</option>
                    <option value="Events/Trips">Events/Trips</option>
                    <option value="Other" selected>Other</option>
                </select>
            </div>
        </div>
        <div class="button-row">
            <button class="btn btn-add" onclick="addPurchase()">Add Purchase</button>
            <button class="btn btn-paid" onclick="markPaidInFull()">Mark Paid in Full</button>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Spending by Category (Smaller View)</div>
        <div class="chart-shell">
            <div class="chart-meta" id="chartMeta">
                Total spent across categories: $0.00 (historic + new, shared via Google Sheets).
            </div>
            <div class="chart-canvas-wrap">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="history-header-row">
            <div class="card-header">History of Purchases & Payments</div>
        </div>
        <div class="history-list" id="historyList"></div>
    </div>
</div>

<div class="notification" id="notification"></div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbwJZCrTzRIRj0MkuDrGhWmyjxOQHgS5BqDAijEYfis-UkLYCP1EyM0pk2N9L6gNyn-v/exec';

let history = [];
let balance = 0;

function formatMoney(a) {
    return '$' + a.toFixed(2);
}

function showNotification(msg) {
    const n = document.getElementById('notification');
    n.textContent = msg;
    n.classList.add('show');
    setTimeout(()=>n.classList.remove('show'), 2500);
}

// ----- backend -----

async function fetchHistoryFromServer() {
    const res = await fetch(API_URL);
    const data = await res.json();
    if (!data.success) throw new Error(data.error || 'Failed to load');
    history = data.history || [];
}

async function postEntryToServer(entry) {
    const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(entry)
    });
    const text = await res.text();
    let data;
    try {
        data = JSON.parse(text);
    } catch (e) {
        throw new Error('Bad JSON from server: ' + text);
    }
    if (!data.success) {
        throw new Error(data.error || 'Failed to save');
    }
    history = data.history || [];
}

// ----- UI + calculations -----

function recomputeTotals() {
    balance = 0;
    history.forEach(item => {
        if (item.type === 'purchase' && !item.settled) {
            balance += Number(item.amount) || 0;
        }
        if (item.type === 'payment') {
            balance += Number(item.amount) || 0;
        }
    });
    document.getElementById('balanceOwed').textContent = formatMoney(balance);
}

function renderHistory() {
    const list = document.getElementById('historyList');
    list.innerHTML = '';

    const items = [...history].sort((a,b)=>new Date(b.date)-new Date(a.date));
    items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'history-item';

        const isPurchase = item.type === 'purchase';
        const amtClass = isPurchase ? 'negative' : 'positive';
        const sign = isPurchase ? '-' : '+';
        const note = isPurchase
            ? (String(item.settled).toLowerCase() === 'true'
               ? 'Purchase (already settled)'
               : 'Purchase (still owed)')
            : 'Payment';

        const amountNum = Number(item.amount) || 0;

        div.innerHTML = `
            <div class="h-date">${item.date}</div>
            <div class="h-main">
                <div class="h-desc">${item.desc}</div>
                <div class="h-note">${item.category} • ${note}</div>
            </div>
            <div>
                <div class="h-amt ${amtClass}">${sign}${formatMoney(Math.abs(amountNum))}</div>
                <div class="h-bal">See balance at top</div>
            </div>
        `;
        list.appendChild(div);
    });
}

function drawCategoryChart() {
    const canvas = document.getElementById('categoryChart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const w = canvas.width = canvas.clientWidth;
    const h = canvas.height = 200;

    ctx.clearRect(0,0,w,h);
    const categoryTotals = {};

    history.forEach(item => {
        if (item.type === 'purchase') {
            if (!categoryTotals[item.category]) categoryTotals[item.category] = 0;
            categoryTotals[item.category] += Number(item.amount) || 0;
        }
    });

    const categories = Object.keys(categoryTotals);
    if (categories.length === 0) return;

    const maxVal = Math.max(...categories.map(c => categoryTotals[c]));
    const padding = 30;
    const chartWidth = w - padding * 2;
    const chartHeight = h - padding * 2;
    const barWidth = chartWidth / (categories.length * 1.5);

    ctx.font = '11px -apple-system,system-ui,sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'bottom';

    categories.forEach((cat, i) => {
        const val = categoryTotals[cat];
        const x = padding + i * (barWidth * 1.5) + barWidth / 2;
        const barHeight = maxVal === 0 ? 0 : (val / maxVal) * chartHeight;
        const y = h - padding - barHeight;

        const grad = ctx.createLinearGradient(0,y,0,y+barHeight);
        grad.addColorStop(0,'#39c66f');
        grad.addColorStop(1,'#8ad3ff');
        ctx.fillStyle = grad;
        ctx.fillRect(x - barWidth/2, y, barWidth, barHeight);

        ctx.fillStyle = '#e5f5ea';
        ctx.fillText('$' + val.toFixed(0), x, y - 4);

        ctx.save();
        ctx.translate(x, h - padding + 14);
        ctx.rotate(-Math.PI/6);
        ctx.fillStyle = '#9fb8aa';
        ctx.textBaseline = 'middle';
        ctx.fillText(cat, 0, 0);
        ctx.restore();
    });

    const totalAll = categories.reduce((sum,c)=>sum+categoryTotals[c],0);
    document.getElementById('chartMeta').textContent =
        'Total spent across categories: $' + totalAll.toFixed(2) +
        ' (historic + new, shared via Google Sheets).';
}

// ----- actions -----

async function refreshFromServer() {
    try {
        await fetchHistoryFromServer();
        recomputeTotals();
        renderHistory();
        drawCategoryChart();
    } catch (e) {
        console.error(e);
        showNotification('Load error: ' + e.message);
    }
}

async function addPurchase() {
    const dateEl = document.getElementById('dateInput');
    const descEl = document.getElementById('descInput');
    const amtEl  = document.getElementById('amountInput');
    const catEl  = document.getElementById('categoryInput');

    const date = dateEl.value || new Date().toISOString().slice(0,10);
    const desc = (descEl.value || '').trim();
    const amount = parseFloat(amtEl.value);
    const category = catEl.value || 'Other';

    if (!desc) { showNotification('Add a description.'); return; }
    if (isNaN(amount) || amount <= 0) { showNotification('Enter a valid amount.'); return; }

    try {
        await postEntryToServer({
            date,
            desc,
            amount,
            category,
            type: 'purchase',
            settled: false
        });
        recomputeTotals();
        renderHistory();
        drawCategoryChart();
        descEl.value = '';
        amtEl.value = '';
        showNotification('Purchase saved.');
    } catch (e) {
        console.error(e);
        showNotification('Save error: ' + e.message);
    }
}

async function markPaidInFull() {
    recomputeTotals();
    if (balance <= 0) {
        showNotification('Nothing owed right now.');
        return;
    }
    const today = new Date().toISOString().slice(0,10);

    try {
        await postEntryToServer({
            date: today,
            desc: 'Paid in full',
            amount: -balance,
            category: 'Other',
            type: 'payment',
            settled: true
        });
        await refreshFromServer();
        showNotification('Marked paid in full.');
    } catch (e) {
        console.error(e);
        showNotification('Paid-in-full error: ' + e.message);
    }
}

// Init
refreshFromServer();
window.addEventListener('resize', drawCategoryChart);
</script>
</body>
</html>
